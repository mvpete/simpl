# Lesson 9 - Working with Libraries

## Intro

SIMPL's power comes not just from the language itself, but from its extensible library system. Libraries let you organize code into reusable modules and extend SIMPL with new functionality written in C++.

In this lesson, you'll learn:
- How to use existing libraries
- How SIMPL libraries are structured
- How to create your own library module
- How C++ bindings work

## Built-in Libraries

SIMPL comes with several built-in libraries:

### IO Library (`@import io`)

Provides input/output functions:

```simpl
@import io

println("Hello, World!");        # Print with newline
print("Enter name: ");          # Print without newline
let name = getln();             # Read line from input
println("Hello, " + name);
```

**Key functions:**
- `print(text)` - Output without newline
- `println(text)` - Output with newline
- `getln()` - Read line from stdin

### Array Library (`@import array`)

Provides array manipulation:

```simpl
@import array

let items = new [1, 2, 3];
push(items, 4);                 # Add to end
let len = length(items);        # Get length
println("Length: " + len);      # 4
```

**Key functions:**
- `push(array, value)` - Add element
- `length(array)` - Get count

## Using Libraries

Import libraries with the `@import` directive:

```simpl
# Single library
@import io

# Multiple libraries
@import io
@import array

# Use library functions
println("Starting...");
let data = new [];
push(data, "item");
```

**Important:** Import directives must come before other code.

## How Libraries Work

Libraries in SIMPL are:

1. **C++ Modules:** Implemented in C++ and registered with the engine
2. **Namespace Providers:** Add functions to the global scope
3. **Loaded on Demand:** Only loaded when imported

### Library Location

Built-in libraries are in: `include/simpl/libraries/`

Example: `include/simpl/libraries/array.h`

## Examining Library Source Code

Let's look at how the array library is implemented:

```cpp
// Simplified from array.h
namespace simpl {
namespace libs {

class array_lib : public library {
public:
    array_lib() {
        // Register 'push' function
        reg_fn("push", [](array& arr, const value_t& val) {
            arr.push_back(val);
        });
        
        // Register 'length' function
        reg_fn("length", [](const array& arr) -> number {
            return static_cast<number>(arr.size());
        });
    }
    
    std::string name() const override { 
        return "array"; 
    }
};

}}
```

Key points:
- Libraries inherit from `library` base class
- Functions registered with `reg_fn`
- Lambda functions implement the logic
- Type conversions handled automatically

## Creating Your Own Library

You can create custom libraries in SIMPL script files!

### Pattern: Utility Module

Create `examples/string_utils.sl`:

```simpl
@import io

# String utility functions

def to_upper_char(c) {
    # Simplified - just demonstrates the pattern
    if(c == "a") { return "A"; }
    if(c == "b") { return "B"; }
    # ... etc
    return c;
}

def string_length(s) {
    # Calculate string length
    # Note: This is example logic
    let len = 0;
    # Would need character iteration
    return len;
}

def string_concat(a, b, c) {
    return a + b + c;
}

println("String utilities loaded");
```

Then use it in another file:

```simpl
# Note: SIMPL doesn't have file imports yet,
# but you could concatenate files or load them sequentially
```

## Library Design Patterns

### Pattern 1: Namespace Simulation

Use a prefix for related functions:

```simpl
def math_abs(x) {
    if(x < 0) { return -x; }
    return x;
}

def math_max(a, b) {
    if(a > b) { return a; }
    return b;
}

def math_min(a, b) {
    if(a < b) { return a; }
    return b;
}
```

### Pattern 2: Configuration Object

Use an object to group related data:

```simpl
object Config {
    debug = false;
    max_items = 100;
    default_name = "User";
}

let app_config = new Config{};

def configure(debug_mode, max) {
    app_config.debug = debug_mode;
    app_config.max_items = max;
}
```

### Pattern 3: Factory Functions

Create objects with validation:

```simpl
def create_user(name, age) {
    if(age < 0) {
        println("Error: Age must be positive");
        return new {};
    }
    
    return new User{ name=name, age=age, created=true };
}
```

## Exercise 9 - Exploring Libraries

Examine the library system:

1. **Read library source:**
   - `include/simpl/libraries/array.h`
   - `include/simpl/libraries/io.h`

2. **Find library registration:**
   - Look for how libraries are registered with the engine
   - See how `@import` directive works

3. **Review library tests:**
   - Check `simpl.test/` for library usage examples

## Your Contribution: Create a Math Library Module

Build a comprehensive math library in SIMPL!

### Task: Build a Math Library

Create `examples/math_lib.sl` with mathematical functions:

**Requirements:**

1. **Basic Operations:**
   - `abs(x)` - Absolute value
   - `max(a, b)` - Maximum
   - `min(a, b)` - Minimum
   - `sign(x)` - Return -1, 0, or 1

2. **Advanced Operations:**
   - `pow(base, exp)` - Power function
   - `sqrt(x)` - Square root (approximation)
   - `gcd(a, b)` - Greatest common divisor
   - `factorial(n)` - Factorial

3. **Array Math:**
   - `sum(arr)` - Sum array elements
   - `product(arr)` - Multiply array elements
   - `mean(arr)` - Average value

**Example skeleton:**

```simpl
@import io
@import array

println("=== Math Library ===");
println("Loading mathematical functions...");

# ===== Basic Operations =====

def abs(x) {
    if(x < 0) {
        return -x;
    }
    return x;
}

def max(a, b) {
    if(a > b) {
        return a;
    }
    return b;
}

def min(a, b) {
    if(a < b) {
        return a;
    }
    return b;
}

def sign(x) {
    if(x > 0) { return 1; }
    if(x < 0) { return -1; }
    return 0;
}

# ===== Advanced Operations =====

def pow(base, exp) {
    if(exp == 0) {
        return 1;
    }
    let result = 1;
    for(let i = 0; i < exp; i = i + 1) {
        result = result * base;
    }
    return result;
}

def sqrt(x) {
    # Newton's method for square root approximation
    if(x < 0) {
        return -1;  # Error
    }
    if(x == 0) {
        return 0;
    }
    
    let guess = x / 2;
    let epsilon = 0.0001;
    
    for(let i = 0; i < 20; i = i + 1) {
        let new_guess = (guess + x / guess) / 2;
        if(abs(new_guess - guess) < epsilon) {
            return new_guess;
        }
        guess = new_guess;
    }
    return guess;
}

def gcd(a, b) {
    # Euclidean algorithm
    if(b == 0) {
        return a;
    }
    return gcd(b, a % b);
}

def factorial(n) {
    if(n <= 1) {
        return 1;
    }
    return n * factorial(n - 1);
}

# ===== Array Math =====

def sum(arr) {
    let total = 0;
    let count = length(arr);
    for(let i = 0; i < count; i = i + 1) {
        total = total + arr[i];
    }
    return total;
}

def product(arr) {
    let result = 1;
    let count = length(arr);
    for(let i = 0; i < count; i = i + 1) {
        result = result * arr[i];
    }
    return result;
}

def mean(arr) {
    return sum(arr) / length(arr);
}

# ===== Testing =====

println("");
println("=== Basic Tests ===");
println("abs(-5) = " + abs(-5));
println("max(10, 20) = " + max(10, 20));
println("min(10, 20) = " + min(10, 20));
println("sign(-7) = " + sign(-7));

println("");
println("=== Advanced Tests ===");
println("pow(2, 10) = " + pow(2, 10));
println("sqrt(16) = " + sqrt(16));
println("sqrt(25) = " + sqrt(25));
println("gcd(48, 18) = " + gcd(48, 18));
println("factorial(6) = " + factorial(6));

println("");
println("=== Array Math Tests ===");
let numbers = new [1, 2, 3, 4, 5];
println("sum([1,2,3,4,5]) = " + sum(numbers));
println("product([1,2,3,4,5]) = " + product(numbers));
println("mean([1,2,3,4,5]) = " + mean(numbers));

println("");
println("Math library ready!");
```

**Expected Output:**
```
=== Math Library ===
Loading mathematical functions...

=== Basic Tests ===
abs(-5) = 5
max(10, 20) = 20
min(10, 20) = 10
sign(-7) = -1

=== Advanced Tests ===
pow(2, 10) = 1024
sqrt(16) = 4.0
sqrt(25) = 5.0
gcd(48, 18) = 6
factorial(6) = 720

=== Array Math Tests ===
sum([1,2,3,4,5]) = 15
product([1,2,3,4,5]) = 120
mean([1,2,3,4,5]) = 3

Math library ready!
```

### Testing Your Library

1. Run your library:
   ```
   simpl.repl.exe ..\examples\math_lib.sl
   ```

2. Verify all functions work correctly

### Bonus Challenges

1. **Add trigonometry functions** (using series approximations):
   - `sin(x)` using Taylor series
   - `cos(x)` using Taylor series

2. **Create a constants object:**
   ```simpl
   object MathConstants {
       PI = 3.14159;
       E = 2.71828;
       GOLDEN_RATIO = 1.61803;
   }
   ```

3. **Add statistical functions:**
   - `median(arr)` - Middle value
   - `mode(arr)` - Most common value
   - `variance(arr)` - Variance

4. **Document your library:**
   - Create `examples/math_lib_readme.md`
   - Document each function with examples

### Commit Your Work

```bash
git add examples/math_lib.sl
git commit -m "Add comprehensive math library module"
```

## Creating C++ Libraries (Advanced)

To create a native C++ library:

1. **Create header file** in `include/simpl/libraries/`
2. **Inherit from library class**
3. **Register functions** in constructor
4. **Register library** with engine

Example structure:

```cpp
namespace simpl {
namespace libs {

class my_lib : public library {
public:
    my_lib() {
        reg_fn("my_function", [](number x) -> number {
            return x * 2;
        });
    }
    
    std::string name() const override { 
        return "mylib"; 
    }
};

}}
```

## Library Best Practices

✅ **Clear naming** - Use descriptive function names  
✅ **Consistent patterns** - Similar functions should work similarly  
✅ **Error handling** - Validate inputs and handle errors gracefully  
✅ **Documentation** - Comment your functions  
✅ **Testing** - Test library functions thoroughly  

## Key Takeaways

✅ **Libraries** organize and extend SIMPL functionality  
✅ **@import** directive loads libraries  
✅ **Built-in libraries** provide core functionality (io, array)  
✅ **Custom libraries** can be created in SIMPL or C++  
✅ **Function registration** makes C++ functions available in SIMPL  
✅ **Type binding** connects SIMPL types to C++ types  

Excellent! You now understand how SIMPL's library system works!

## Next
[Lesson 10](https://github.com/mvpete/simpl/blob/master/lessons/L10.md)
