# Lesson 7 - Arrays and Collections

## Intro

Arrays are fundamental data structures in any programming language. In SIMPL, arrays are dynamic, heterogeneous collections that can hold any mix of types: numbers, strings, objects, even other arrays or functions!

Arrays in SIMPL are:
- **Dynamic** - grow and shrink as needed
- **Heterogeneous** - can mix different types
- **Zero-indexed** - first element is at index 0
- **Mutable** - can modify elements after creation

## Creating Arrays

Use the `new` keyword with square brackets:

```simpl
# Empty array
let empty = new [];

# Array with initial values
let numbers = new [1, 2, 3, 4, 5];

# Mixed types
let mixed = new ["hello", 42, new {}, 3.14];

# Nested arrays
let matrix = new [
    new [1, 2, 3],
    new [4, 5, 6],
    new [7, 8, 9]
];
```

## Accessing Array Elements

Use square bracket notation with an index:

```simpl
@import io

let fruits = new ["apple", "banana", "cherry"];

println(fruits[0]);  # "apple"
println(fruits[1]);  # "banana"
println(fruits[2]);  # "cherry"
```

## Modifying Arrays

You can change array elements by index:

```simpl
let numbers = new [10, 20, 30];
numbers[1] = 99;
println(numbers[1]);  # 99
```

## Array Library Functions

SIMPL provides an `array` library with useful functions:

```simpl
@import io
@import array

let items = new ["first", "second"];

# Add elements
push(items, "third");
push(items, "fourth");

# Get array length
let len = length(items);
println("Array has " + len + " items");

# Print all elements
println(items);
```

### Common Array Functions

- `push(array, value)` - Add element to end
- `length(array)` - Get number of elements
- More functions may be available - check `include/simpl/libraries/array.h`

## Array Explosion Operator

The `...` operator "explodes" an array into individual arguments:

```simpl
def print_three(a, b, c) {
    println("a=" + a);
    println("b=" + b);
    println("c=" + c);
}

let args = new ["first", "second", "third"];
print_three(args...);  # Unpacks to: print_three("first", "second", "third")
```

This is powerful when combined with multi-methods:

```simpl
def process(x is string, y is number) {
    println("Processing: " + x + " and " + y);
}

let data = new ["hello", 42];
process(data...);  # Correctly dispatches based on unpacked types
```

## Iterating Over Arrays

Use a for loop with array indexing:

```simpl
@import io

let colors = new ["red", "green", "blue", "yellow"];

for(let i = 0; i < 4; i = i + 1) {
    println("Color " + i + ": " + colors[i]);
}
```

## Nested Arrays (2D Arrays)

Arrays can contain other arrays:

```simpl
@import io

let grid = new [
    new [1, 2, 3],
    new [4, 5, 6],
    new [7, 8, 9]
];

# Access nested elements
println(grid[0][0]);  # 1
println(grid[1][2]);  # 6
println(grid[2][1]);  # 8

# Modify nested elements
grid[1][1] = 99;
println(grid[1][1]);  # 99
```

## Arrays of Objects

Arrays can store custom objects:

```simpl
@import io

object Player {
    name = "Unknown";
    score = 0;
}

let players = new [
    new Player{ name="Alice", score=100 },
    new Player{ name="Bob", score=85 },
    new Player{ name="Charlie", score=92 }
];

# Access object properties in array
println(players[0].name);   # "Alice"
println(players[1].score);  # 85

# Modify object in array
players[2].score = 95;
```

## Exercise 7 - Working with Arrays

Explore array functionality in the codebase:

1. Review `examples/array.sl` - comprehensive array examples
2. Check `include/simpl/libraries/array.h` - array library implementation
3. Look at tests in `simpl.test/simpl.engine.test.cpp` for array-related tests

Key tests to review:
- `TestArrayExplosionSimple` - Array explosion with multi-methods
- `TestArrayExplosionTypeMismatch` - Type checking with explosion
- `TestNonArrayExplosion` - Error handling

## Your Contribution: Build a Data Management System

Create a program that manages a collection of data using arrays!

### Task: Inventory Management System

Create `examples/inventory.sl` that manages an inventory of items:

**Requirements:**

1. Define an `Item` object with properties:
   - `name` (string)
   - `quantity` (number)
   - `price` (number)

2. Create an array to store multiple items

3. Implement functions to:
   - Add items to inventory
   - Display all items
   - Calculate total inventory value
   - Find an item by name (optional)

**Example skeleton:**

```simpl
@import io
@import array

object Item {
    name = "Unknown";
    quantity = 0;
    price = 0.0;
}

# Create inventory array
let inventory = new [];

# Function to add item to inventory
def add_item(name, qty, price) {
    let item = new Item{ name=name, quantity=qty, price=price };
    push(inventory, item);
    println("Added: " + name);
}

# Function to display all items
def display_inventory() {
    println("=== Inventory ===");
    let count = length(inventory);
    for(let i = 0; i < count; i = i + 1) {
        let item = inventory[i];
        println(item.name + ": " + item.quantity + " @ $" + item.price);
    }
}

# Function to calculate total value
def total_value() {
    let total = 0;
    let count = length(inventory);
    for(let i = 0; i < count; i = i + 1) {
        let item = inventory[i];
        total = total + (item.quantity * item.price);
    }
    return total;
}

# Test the system
add_item("Sword", 5, 50.0);
add_item("Shield", 3, 75.0);
add_item("Potion", 20, 10.0);

display_inventory();

let total = total_value();
println("Total inventory value: $" + total);
```

**Expected Output:**
```
Added: Sword
Added: Shield
Added: Potion
=== Inventory ===
Sword: 5 @ $50.0
Shield: 3 @ $75.0
Potion: 20 @ $10.0
Total inventory value: $675.0
```

### Testing Your Code

1. Run your program:
   ```
   simpl.repl.exe ..\examples\inventory.sl
   ```

2. Verify:
   - Items are added correctly
   - Display shows all items
   - Total value calculation is accurate
   - No errors occur

### Bonus Challenges

1. **Search function:**
   ```simpl
   def find_item(search_name) {
       let count = length(inventory);
       for(let i = 0; i < count; i = i + 1) {
           if(inventory[i].name == search_name) {
               return inventory[i];
           }
       }
       return "Not found";
   }
   ```

2. **Remove item function:**
   - Remove an item from the inventory by name

3. **Sort items:**
   - Sort inventory by price or quantity

4. **Add a test:**
   - Create a test in `simpl.test/simpl.engine.test.cpp`
   - Test array operations work correctly

```cpp
TEST_METHOD(TestArrayPushAndLength)
{
    auto ast = simpl::parse(
        "@import array "
        "let arr = new [1, 2]; "
        "push(arr, 3); "
        "let len = length(arr); "
        "assert(len);"
    );
    
    bool called = false;
    check = [&](const simpl::value_t& v) {
        called = true;
        Assert::IsTrue(std::holds_alternative<simpl::number>(v));
        Assert::AreEqual(3.0, std::get<simpl::number>(v));
    };
    
    simpl::evaluate(ast, e);
    Assert::IsTrue(called);
}
```

### Commit Your Work

```bash
git add examples/inventory.sl
git commit -m "Add inventory management system using arrays"
```

## Array Implementation Details

Under the hood:
- Arrays are implemented as `std::vector` in C++
- Dynamic resizing happens automatically
- Random access is O(1)
- Push operations are typically O(1) (amortized)

## Common Patterns

**Building arrays dynamically:**
```simpl
let results = new [];
for(let i = 0; i < 10; i = i + 1) {
    push(results, i * i);
}
```

**Processing array data:**
```simpl
let sum = 0;
let count = length(data);
for(let i = 0; i < count; i = i + 1) {
    sum = sum + data[i];
}
let average = sum / count;
```

**Filtering arrays:**
```simpl
let evens = new [];
for(let i = 0; i < length(numbers); i = i + 1) {
    if(numbers[i] % 2 == 0) {
        push(evens, numbers[i]);
    }
}
```

## Key Takeaways

✅ **Arrays** store ordered collections of any type  
✅ **Dynamic sizing** with `push()` function  
✅ **Zero-indexed** access with `[index]`  
✅ **Explosion operator** `...` unpacks arrays to arguments  
✅ **Nested arrays** allow multi-dimensional data  
✅ **Mix types freely** - numbers, strings, objects, arrays  

Excellent! You now know how to work with collections in SIMPL!

## Next
[Lesson 8](https://github.com/mvpete/simpl/blob/master/lessons/L8.md)
